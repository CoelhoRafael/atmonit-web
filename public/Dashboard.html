<html lang="pt-br">

<head>
  <title>Dashboard</title>
  <script src="./js/dashboard.js"></script>
  <link rel="stylesheet" href="css/style-dashboard.css" type="text/css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
  </script>
</head>
</head>

<body onload = "obterDadosGrafico(18)">

  <div id="mySidenav" class="sidenav">
    <div class="logo">
      <img src="img/atmonit.svg" alt="" class="logo-img">
    </div>
    <a href="home.html" class="icon-a"><i class="fa fa-home icons"></i> Home</a>
    <a href="#" class="icon-a selected"><i class="fas fa-chart-line icons"></i> Dashboard</a>
    <a href="inovacao.html" class="icon-a"><i class="fa fa-users icons"></i> Filas</a>
    <a href="login.html" class="icon-a"><i class="fa fa-sign-out-alt icons"></i> Logout</a>


  </div>
  <div id="main">

    <div class="head">
      <div class="col-div-6">
        <span style="font-size:30px;cursor:pointer; color: #f1f1f1e7;" class="nav"><i
            class="fas fa-chart-line icons"></i> Dashboard</span>
      </div>

    </div>


    <br />

    <div class="col-div-3">
      <div class="box expand">
        <p>40%<br />
          <span id="span_ram" class="indicator-subtitle">RAM</span>
        </p>
        <!-- <i class="fa fa-users box-icon"></i> -->
      </div>



      <div class="box expand">
        <p>50%<br />
          <span id="span_cpu" class="indicator-subtitle">CPU</span>
        </p>
      </div>



      <div class="box expand">
        <p>35%
          <br>
          <span id="span_disco" class="indicator-subtitle">DISCO</span>
        </p>
        <!-- <i class="fa fa-shopping-bag box-icon"></i> -->
      </div>


      <div class="col-div-3">
        <div class="box expand">
          <span class="status-title">Indices De Uso</span>
          <div class="status-position">
            <span class="status-info">
              <div class="indicator normal"></div>Moderado
            </span>
            <span class="status-info unused">
              <div class="indicator caution"></div> Frequente
            </span>
            <span class="status-info unused">
              <div class="indicator danger"></div> Intenso
            </span>
          </div>
        </div>
      </div>

    </div>


    <div class="clearfix"></div>
    <br /><br />
    <div class="col-div-8">
      <div class="box-8">
        <div class="content-box">
          <h2 class="card-title">Desempenho Mensal Do Caixa</h2>
          <div id="chart_div" class="graphic"></div>
        </div>
      </div>
    </div>
  </div>

</body>

</html>
<script>
  let proximaAtualizacao;

  // b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  //verificar_autenticacao();

  // altere aqui como os dados serão exibidos
  // e como são recuperados do BackEnd
  function obterDadosGrafico(idMaquina) {
    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }
    fetch(`/medidas/ultimas/${idMaquina}`, {
        cache: 'no-store'
      }).then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            // console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse()
            plotarGrafico(resposta, idMaquina);
          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }

  // só altere aqui se souber o que está fazendo!
  function plotarGrafico(resposta, idMaquina) {
    console.log('iniciando plotagem do gráfico...');

    google.charts.load('current', {
      packages: ['corechart', 'line']
    });
    google.charts.setOnLoadCallback(drawBasic);

    function drawBasic() {

      var dados = new google.visualization.DataTable();
      dados.addColumn('string', 'Hora');
      dados.addColumn('number', 'RAM');
      dados.addColumn('number', 'CPU');
      dados.addColumn('number', 'DISCO');

      var options = {
        legend: {
          textStyle: {
            color: '#FFF'
          },
        },
        hAxis: {
          title: 'TEMPO',
          textStyle: {
            color: '#ffffff',
            fontSize: 18,
            fontName: 'Arial',
            bold: true
            // italic: true
          },
          titleTextStyle: {
            color: '#ffffff',
            fontSize: 18,
            bold: true
          },
        },
        vAxis: {
          maxValue: 100,
          title: 'DESEMPENHO',
          textStyle: {
            color: '#ffffff',
            fontSize: 18,
            fontName: 'Arial',
            bold: true
            // italic: true
          },
          titleTextStyle: {
            color: '#ffffff',
            fontSize: 18,
            bold: true
          },
        },
        textStyle: {
          color: '#ffffff',
          fontSize: 18,
          fontName: 'Arial',
          bold: true
          // italic: true
        },
        backgroundColor: '#272c4a',

      };
      for (i = 0; i < resposta.length; i++) {
        var registro = resposta[i];
        var CPU, RAM, HD1
        if (registro.name_component == 'Processor') {
          CPU = Math.round(registro.percentage_usage)
        }
        if (registro.name_component == 'Ram memory') {
          RAM = Math.round(registro.percentage_usage* 100 / registro.ram_memory)
        }
        if (registro.name_component == 'Hard Disk 1') {
          HD1 = -(Math.round(registro.percentage_usage / 100000000 * 100 / registro.terminal_storage))
        }
        dados.addRows([
          [registro.date_time, RAM , CPU, HD1]
        ])
      }

      var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
      chart.draw(dados, options);
      setTimeout(() => atualizarGrafico(idMaquina, dados), 2000);
      

    }
    //Atualiza os dados de 2 em 2 segundos

  }

  // só mexer se quiser alterar o tempo de atualização
  // ou se souber o que está fazendo!
  function atualizarGrafico(idMaquina, dados) {
    fetch(`/medidas/tempo-real/${idMaquina}`, {
        cache: 'no-store'
      }).then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {

            // console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            // console.log(`Dados atuais do gráfico: ${dados}`);

            var CPU, RAM, HD1
            if (novoRegistro.name_component == 'Processor') {
              CPU = Math.round(novoRegistro.percentage_usage)
            }
            if (novoRegistro.name_component == 'Ram memory') {
              RAM = Math.round(novoRegistro.percentage_usage * 100 / novoRegistro.ram_memory)
            }
            if (novoRegistro.name_component == 'Hard Disk 1') {
              HD1 = -(Math.round(registro.percentage_usage / 100000000 * 100 / registro.terminal_storage))
            }
            // tirando e colocando valores no gráfico
            dados.removeRow(0);
            dados.addRows([[novoRegistro.date_time, RAM , CPU, HD1]])
            dados.removeRow(1);
            dados.addRows([[novoRegistro.date_time, RAM , CPU, HD1]])
            dados.removeRow(2);
            dados.addRows([[novoRegistro.date_time, RAM , CPU, HD1]])
            dados.removeRow(3); // apagar o primeiro
            dados.addRows([[novoRegistro.date_time, RAM , CPU, HD1]])
            // incluir uma nova medida de umidade
            
            this.google.charts.setOnLoadCallback()
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados), 2000);
          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados), 2000);
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }
</script>